\documentclass[utf8]{beamer}
\mode<presentation>
\usepackage{listings}
\usepackage{helvet}
\usetheme{Warsaw}
\usecolortheme{whale}
\usefonttheme[onlylarge]{structuresmallcapsserif}
\usefonttheme[onlysmall]{structurebold}

\setbeamercovered{dynamic}
\setbeameroption{show notes}

\begin{document}
\title{Scaling Erlang Web Applications}
\subtitle{100 to 100K users at one web server}
\author{Fernando Benavides (\textit{@elbrujohalcon})}
\institute{Inaka Labs}
\date{\today}

\lstset{% general command to set parameter(s)
		basicstyle=\ttfamily\tiny, % print whole listing small
		keywordstyle=\color{black}\bfseries,
		identifierstyle=, % nothing happens
		stringstyle=\ttfamily, % typewriter type for strings
		showstringspaces=false} % no special string spaces

\frame{\titlepage} 

\begin{frame}
	\frametitle{Hello World!}
	\begin{itemize}
		\item<+-> I'm a developer since I was 10
		\item<+-> I'm an Erlang developer since 2008
		\item<+-> I've worked in many dynamic web sites
		\item<+-> Most of them with high scale requirements
		\item<+-> I'll share my experience with you 
	\end{itemize}
\end{frame}

% \frame{\frametitle{Outline}\tableofcontents[pausesections]}
\begin{frame}{Outline}
	\begin{description}
		\item<+->[The Challenge] {\ \\ What do we have to deal with? \\ \ }
		\item<+->[The Plan] {\ \\ How do we face it? \\ \  }
		\item<+->[The Tips and Tricks] {\ \\ What have we learned from it? \\ \ }
	\end{description}
\end{frame}

\section{The Challenge}
\subsection{Description}
\begin{frame}
	We will work on the scalability of a \emph{web} project \pause that has an \emph{HTTP API} \pause and keeps clients \emph{connected} to the server \pause for \emph{long periods} of time.\\
\pause Examples:
	\begin{itemize}
		\item Social sites
		\item Chat sites
		\item Sports sites
	\end{itemize}
\end{frame}

\subsection{Scope}
\begin{frame}
	\emph{We will focus on}
	\begin{itemize}
		\item OTP behaviours
		\item TCP connections
		\item mochiweb
		\item Underlaying system configurations
	\end{itemize}
	\pause
	\emph{We will \textbf{not} deal with}
	\begin{itemize}
		\item Multiple machines/nodes
		\item Databases
	\end{itemize}
\end{frame}

\section{The Plan}
\begin{frame}
	\center{\textsc{\huge{The Plan}}}
\end{frame}

\begin{frame}{General Considerations}
	\begin{itemize}
		\item<1,5> Create a system that \alert{works}
		\item<2,5> Automate your clients
		\item<3,5> Keep a human watching
		\item<4,5> Be patient
	\end{itemize}
\end{frame}

\subsection{Finding The Initial Boundaries}
\begin{frame}{Goals}
	\begin{itemize}
		\item Test the system as it is
		\item How many users can the system handle \alert{as is}?
		\item Find $N$ and $C$
	\end{itemize}
\end{frame}
\begin{frame}{Steps}
	\begin{itemize}
		\item Choose $N$ and $C$
		\item Test the API
		\item Test long-lived connections
		\item Test both
		\pause
		\item Repeat with higher values for $N$ and $C$
	\end{itemize}
\end{frame}

\subsection{Blackbox Tests}
\begin{frame}{Goals}
	\begin{itemize}
		\item Improve the system environment
		\item Tune-In the machine(s)
		\item \alert{Don't} touch the code
	\end{itemize}
\end{frame}
\begin{frame}{Steps}
	\begin{itemize}
		\item Check kernel variables
		\item Check system limits
		\item Check Erlang VM parameters
	\end{itemize}
\end{frame}

\subsection{Erlang Tuning}
\begin{frame}{Goals}
	\begin{itemize}
		\item Tune up \alert{your} system
		\item Discover scalability issues and fix them
		\item Find the biggest $N$ and $C$ for \alert{one node}
	\end{itemize}
\end{frame}
\begin{frame}{Steps}
	\begin{itemize}
		\item Choose $N$ and $C$ to fail
		\item Find a problem
		\item Fix it
		\item Add it to the list of \emph{Tips and Tricks}
		\pause
		\item Repeat with higher values for $N$ and $C$
	\end{itemize}
\end{frame}

\subsection{Adding Nodes}
\begin{frame}{Goals}
	\begin{itemize}
		\item Get the system ready to work on many nodes
		\item Design the system topology
		\item Find $N$ and $C$ \alert{per node}
	\end{itemize}
\end{frame}
\begin{frame}{Steps}
	\begin{itemize}
		\item Get the second node running
		\item Choose $N$ and $C$
		\item Try interconnected instances
		\item Try independent instances
		\pause
		\item Repeat with higher values for $N$ and $C$
	\end{itemize}
\end{frame}

\section{Tips and Tricks}
\subsection{TCP Tunning}

\lstset{language=sh}
\defverbatim[colored]\kernelvars{%
\begin{lstlisting}[frame=single, emph={sysctl}, emphstyle={\color{blue}}]
      sysctl -w net.ipv4.ip_local_port_range="1024 65535"
      sysctl -w net.core.rmem_max=16777216
      sysctl -w net.core.wmem_max=16777216
      sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
      sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
      sysctl -w net.ipv4.tcp_syncookies=1
      sysctl -w net.ipv4.tcp_mem="50576   64768   98152"
      sysctl -w net.core.netdev_max_backlog=2500
      sysctl -w net.netfilter.nf_conntrack_max=1233000
\end{lstlisting}
}
\defverbatim[colored]\ulimit{%
\begin{lstlisting}[frame=single]
      ulimit -n 999999
\end{lstlisting}
}
\lstset{language=erlang}
\defverbatim[colored]\startchild{%
\begin{lstlisting}[frame=single]
      supervisor:start_child(
      	list_to_atom("module-name_" ++
				integer_to_list(random:uniform(#ofSupervisors))).
\end{lstlisting}
}

\begin{frame}{OS tweaks}
	\emph{Kernel Variables}
	\kernelvars
	\pause
	\emph{Open Files Limit}
	\ulimit
	\pause
	\emph{Erlang VM tweaks}
	\begin{description}
		\item[+P] Number of Processes
		\item[+K] Kernell Polling
		\item[-smp] SMP Support
	\end{description}
\end{frame}
\begin{frame}{Connection tweaks}
	\begin{description}
		\item<+->[Backlog]\ \\
			\begin{itemize}
				\item Allow more concurrent connections
				\item Remember HTTP \emph{runs on} TCP
			\end{itemize}
		\item<+->[Connections]\ \\
			\begin{itemize}
				\item Don't use just one of them
				\item Check inbound and outbound connections
			\end{itemize}
	\end{description}
\end{frame}
\subsection{OTP}
\begin{frame}{gen\textunderscore event}
	\begin{description}
		\item<+->[sup\textunderscore handler]\ \\
			\begin{itemize}
				\item Don't use it
				\item Monitor the processes instead
			\end{itemize}
		\item<+->[Long Delivery Queues]\ \\
			\begin{itemize}
				\item Use \emph{repeaters}
			\end{itemize}
	\end{description}
\end{frame}
\begin{frame}{gen\textunderscore servers}
	\begin{description}
		\item<+->[Call Timeouts]\ \\
			Remember \texttt{gen\textunderscore server:reply/2}
		\item<+->[Memory Footprint]\ \\
			Remember \texttt{hibernate}
		\item<+->[Long \texttt{init/1}]\ \\
			Use $0$ timeout
	\end{description}
\end{frame}
\begin{frame}{supervisors}
	\begin{itemize}
		\item Sometimes \texttt{simple\textunderscore one\textunderscore for\textunderscore one} supervisors get \alert{overburdened} because they have too many children
		\item Try a supervisor hierarchy with several managers below the main supervisor
		\item Turn \texttt{supervisor:start\textunderscore child/2} calls into something like
		\startchild
	\end{itemize}
\end{frame}
\subsection{Other Stuff}
\begin{frame}
	\begin{description}
		\item<+->[Timers]\ \\
			\begin{itemize}
				\item Don't use the \texttt{timer} module
				\item Use \texttt{erlang:send\textunderscore after}
			\end{itemize}
		\item<+->[Logging]\ \\
			\begin{itemize}
				\item Don't log too much
				\item Use a good logging system
			\end{itemize}
		\item<+->[Registration]\ \\
			Sometimes it's better to register processes instead of keeping track of their pids manually
	\end{description}
\end{frame}

\section{Final Words}
\subsection{Summary}
\begin{frame}{Summary}
	TODO: Summary
\end{frame}
\subsection{Other stuff}
\begin{frame}{Other stuff}{that we left out of this presentation}
	TODO: List of other scalability stuff we left out
\end{frame}
\subsection{Questions}
\begin{frame}
	\alert{Any questions?}
\end{frame}

\appendix

\lstset{language=erlang}
\defverbatim[colored]\mycode{%
\begin{lstlisting}[frame=single, emph={fact}, emphstyle={\color{blue}}]
-spec fact(integer()) -> integer().
fact(N) ->
	lists:fold(fun(X, F) ->
			F * X
		   end, 1, lists:seq(1,N)).
\end{lstlisting}
}

\section{Some Code}
\begin{frame}
\mycode
\end{frame}

\end{document}