\documentclass[utf8]{beamer}
\mode<presentation>
\usepackage{listings}
\usepackage{helvet}
\usetheme{Warsaw}
\usecolortheme{whale}
\usefonttheme[onlylarge]{structuresmallcapsserif}
\usefonttheme[onlysmall]{structurebold}

\setbeamercovered{dynamic}
\setbeameroption{show notes}

\begin{document}
\title{Scaling Erlang Web Applications}
\subtitle{100 to 100K users at one web server}
\author{Fernando Benavides (\textit{@elbrujohalcon})}
\institute{Inaka Labs}
\date{\today}
\logo{\includegraphics[height=0.5cm]{img/inaka_leaf_logo.png}}

\lstset{% general command to set parameter(s)
		basicstyle=\ttfamily\tiny, % print whole listing small
		keywordstyle=\color{black}\bfseries,
		identifierstyle=, % nothing happens
		stringstyle=\ttfamily, % typewriter type for strings
		showstringspaces=false} % no special string spaces

\frame{\titlepage} 

\begin{frame}[t]
	\frametitle{Hello World!}
	\begin{itemize}
		\item<+-> I'm a developer since I was 10
		\item<+-> I'm an Erlang developer since 2008
		\item<+-> I've worked in many dynamic web sites
		\item<+-> Most of them with high scale requirements
		\item<+-> I'll share my experience with you
	\end{itemize}
	\only<1>{
		\begin{center}
			\includegraphics[width=.65\textwidth]{img/Gorillas.png}
		\end{center}
	}
	\only<2>{
		\begin{center}
			\includegraphics[width=.65\textwidth]{img/ErlangASCIIArt.png}
		\end{center}
	}
\end{frame}

\frame{\frametitle{Outline}\tableofcontents[pausesections]}

\section{Introduction}
\subsection{Description}
\begin{frame}{Introduction}
	We will work on the scalability of a \emph{web} project \pause that has an \emph{HTTP API} \pause and a component that keeps clients \emph{connected} to the server \pause for \emph{long periods} of time.\\
\pause Examples:
	\begin{itemize}
		\item<+-> Social sites
		\item<+-> Chat sites
		\item<+-> Sports sites
	\end{itemize}
\end{frame}

\subsection{Scope}
\begin{frame}{Scope}
	\emph{We will try to improve the way we use}
	\begin{itemize}
		\item OTP behaviours
		\item TCP and HTTP connections
		\item Underlaying system configurations
	\end{itemize}
	\pause
	\emph{We will \textbf{not} deal with}
	\begin{itemize}
		\item Multiple machines/nodes
		\item Database choices and/or implementations
	\end{itemize}
\end{frame}

\section{The Project}
\subsection{Idea}
\begin{frame}{Match Stream}
	TODO: General system design graph
\end{frame}
\begin{frame}{Requirements}
	This kind of system requires\ldots \pause
	\begin{itemize}
		\item<+-> Tons of users
		\item<+-> In two-hour-long bursts
		\item<+-> Real-time updates
	\end{itemize}
	\onslide<+->Erlang seems to be \textbf{the right fit for this}
\end{frame}

\subsection{Design}
\begin{frame}{Match Stream}{General Design}
	\includegraphics[width=\textwidth]{img/MatchStream.png}
\end{frame}
\begin{frame}{Match Stream}{Architecture}
	\begin{center}
		\includegraphics[height=.75\textheight]{img/running.png}
	\end{center}
\end{frame}
\subsection{Components}
\begin{frame}{For the Clients}
	\begin{description}
		\item<+->[client\_listener]\ \\
			\texttt{gen\_server}. Handles a listening TCP port to receive clients
		\item<+->[client\_sup]\ \\
			\texttt{supervisor}. Supervises client processes
		\item<+->[user\_sup]\ \\
			\texttt{supervisor}. Supervises user processes
		\item<+->[web]\ \\
			\texttt{mochiweb}. Listener for HTTP API calls
	\end{description}
\end{frame}
\begin{frame}{DB and Matches}
	\begin{description}
		\item<+->[db]\ \\
			\texttt{gen\_server}. Handles a connection to the DB
		\item<+->[match\_sup]\ \\
			\texttt{supervisor}. Supervises match processes
	\end{description}
\end{frame}

I'M HERE

\section{Scaling}
\begin{frame}{Lesson Learned}
	\begin{center}
		\Large \emph{Using Erlang to build your system is \textbf{not enough} to ensure \textbf{scalability}}
	\end{center}
\end{frame}

\begin{frame}{General Rules}{Things you need to know when scaling your systems}
	\begin{itemize}
		\item<1> Start with a system that \alert{works}
		\item<2> Automate your clients
		\item<3> Keep a human watching
		\item<4> Be patient
	\end{itemize}
\end{frame}

\subsection{Finding The Initial Boundaries}
\begin{frame}{Stage 1}{Finding The Initial Boundaries}
	\textsc{Goals}
	\begin{itemize}
		\item Test the system as it is
		\item Find $N$ and $C$
	\end{itemize}
	\pause
	\textsc{Steps}
	\begin{itemize}
		\item Create the automated testers
		\item Choose $N$ and $C$
		\item Test the API and long-lived connections independently
		\item Test both together
		\item Repeat until you find the highest $N$ and $C$
	\end{itemize}
\end{frame}
\begin{frame}{Stage 1}{Finding The Initial Boundaries}
	\textsc{Results}
	\includegraphics[top=-1,width=\textwidth]{img/MatchStream-1.png}
\end{frame}

\subsection{Blackbox Tests}
\begin{frame}{Stage 2}{Blackbox Tests}
	\textsc{Goals}
	\begin{itemize}
		\item Improve the system environment
		\item Find the highest $N$ and $C$ without altering the code
	\end{itemize}
	\pause
	\textsc{Steps}
	\begin{itemize}
		\item Check kernel variables
		\item Check system limits
		\item Check Erlang VM parameters
		\item Repeat \alert{from Stage 1}
	\end{itemize}
\end{frame}
\begin{frame}{Stage 2}{Blackbox Tests}
	\textsc{Results}
	\includegraphics[top=-1,width=\textwidth]{img/MatchStream-2.png}
\end{frame}

\subsection{Erlang Tuning}
\begin{frame}{Stage 3}{Erlang Tuning}
	\textsc{Goals}
	\begin{itemize}
		\item Tune up \alert{your} system
		\item Find the highest $N$ and $C$ for \alert{one node}
	\end{itemize}
	\pause
	\textsc{Steps}
	\begin{itemize}
		\item Find a problem
		\item Fix it using the list of \emph{Tips and Tricks}
		\item If not there, add it
		\item Repeat \alert{from Stage 1}
	\end{itemize}
\end{frame}
\begin{frame}{Stage 3}{Erlang Tuning}
	\textsc{Results}
	\includegraphics[top=-1,width=\textwidth]{img/MatchStream-3.png}
\end{frame}

\subsection{Adding Nodes}
\begin{frame}{Stage 4}{Adding Nodes}
	\textsc{Goals}
	\begin{itemize}
		\item Find the best system topology
		\item Find $N$ and $C$ \alert{per node}
	\end{itemize}
	\pause
	\textsc{Steps}
	\begin{itemize}
		\item Add a node
		\begin{itemize}
			\item connected; or
			\item independent
		\end{itemize}
		\item Repeat \alert{from Stage 1}
	\end{itemize}
\end{frame}
\begin{frame}{Stage 4}{Adding Nodes}
	\textsc{Results}
	\includegraphics[top=-1,width=\textwidth]{img/MatchStream-4.png}
\end{frame}
\begin{frame}{Match Stream}{Final Architecture}
	\begin{center}
		\includegraphics[height=.75\textheight]{img/running-late.png}
	\end{center}
\end{frame}

\section{Tips and Tricks}
\begin{frame}{Tips and Tricks}
	\begin{center}
		\includegraphics[width=.65\textwidth]{img/macgyver.jpg}
	\end{center}
\end{frame}

\subsection{TCP Tunning}

\lstset{language=sh}
\defverbatim[colored]\kernelvars{%
\begin{lstlisting}[frame=single, emph={sysctl}, emphstyle={\color{blue}}]
      sysctl -w net.ipv4.ip_local_port_range="1024 65535"
      sysctl -w net.core.rmem_max=16777216
      sysctl -w net.core.wmem_max=16777216
      sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
      sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
      sysctl -w net.ipv4.tcp_syncookies=1
      sysctl -w net.ipv4.tcp_mem="50576   64768   98152"
      sysctl -w net.core.netdev_max_backlog=2500
      sysctl -w net.netfilter.nf_conntrack_max=1233000
\end{lstlisting}
}
\defverbatim[colored]\ulimit{%
\begin{lstlisting}[frame=single]
      ulimit -n 999999
\end{lstlisting}
}
\lstset{language=erlang}
\defverbatim[colored]\startchild{%
\begin{lstlisting}[frame=single]
      supervisor:start_child(
      	list_to_atom("module-name_" ++
				integer_to_list(random:uniform(#ofSupervisors))).
\end{lstlisting}
}

\begin{frame}{OS tweaks}
	\emph{Kernel Variables}
	\kernelvars
	\pause
	\only<2>{
		\begin{center}
			\includegraphics[width=.5\textwidth]{img/omg.jpg}
		\end{center}
	}
	\pause
	\emph{Open Files Limit}
	\ulimit
	\pause
	\emph{Erlang VM tweaks}
	\begin{description}
		\item[+P] Number of Processes
		\item[+K] Kernell Polling
		\item[-smp] SMP Support
	\end{description}
\end{frame}
\begin{frame}{Connection tweaks}
	\begin{description}
		\item<+->[Backlog]\ \\
			\begin{itemize}
				\item Allow more concurrent connections
				\item Remember HTTP \emph{runs on} TCP
			\end{itemize}
		\item<+->[Connections]\ \\
			\begin{itemize}
				\item Don't use just one of them
				\item Check inbound and outbound connections
			\end{itemize}
	\end{description}
\end{frame}
\subsection{OTP}
\begin{frame}{gen\textunderscore event}
	\begin{description}
		\item<+->[sup\textunderscore handler]\ \\
			\begin{itemize}
				\item Don't use it
				\item Monitor the processes instead
			\end{itemize}
		\item<+->[Long Delivery Queues]\ \\
			\begin{itemize}
				\item Use \emph{repeaters}
			\end{itemize}
	\end{description}
\end{frame}
\begin{frame}{gen\textunderscore server}
	\begin{description}
		\item<+->[Call Timeouts]\ \\
			Remember \texttt{gen\textunderscore server:reply/2}
		\item<+->[Memory Footprint]\ \\
			Remember \texttt{hibernate}
		\item<+->[Long \texttt{init/1}]\ \\
			Use $0$ timeout
	\end{description}
\end{frame}
\begin{frame}{supervisors}
	\begin{itemize}
		\item Sometimes \texttt{simple\textunderscore one\textunderscore for\textunderscore one} supervisors get \alert{overburdened} because they have too many children
		\item Try a supervisor hierarchy with several managers below the main supervisor
		\item Turn \texttt{supervisor:start\textunderscore child/2} calls into something like
		\startchild
	\end{itemize}
\end{frame}
\subsection{Other Stuff}
\begin{frame}{Other Processes}
	\begin{description}
		\item<+->[Timers]\ \\
			\begin{itemize}
				\item Don't use the \texttt{timer} module
				\item Use \texttt{erlang:send\textunderscore after}
			\end{itemize}
		\item<+->[Logging]\ \\
			\begin{itemize}
				\item Don't log too much
				\item Use a good logging system
			\end{itemize}
		\item<+->[Registration]\ \\
			\begin{itemize}
				\item Sometimes it's better to register processes instead of keeping track of their pids manually
				\item You can always register processes \alert{both} locally and globally
			\end{itemize}
	\end{description}
\end{frame}

\section{Final Words}
\subsection{Summary}
\begin{frame}{Summary}
	\begin{itemize}
		\item<+-> This is an \alert{iterative} process
		\item<+-> It worked awesomely for us in both experimental and real-life systems
		\item<+-> It's no \alert{silver bullet}
		\item<+-> The list of \emph{Tips and Tricks} grows \alert{constantly} over time
	\end{itemize}
\end{frame}
\subsection{What's next?}
\begin{frame}{Scaling Topics}{that weren't covered on this presentation}
	\begin{itemize}
		\item Adding nodes
		\item Choosing databases
		\item System specific improvements
		\item Measuring tools
	\end{itemize}
\end{frame}
\subsection{Questions}
\begin{frame}{Questions}
	\begin{center}
		\includegraphics[width=\textwidth]{img/theriddler.jpg}
	\end{center}
\end{frame}

\appendix

\begin{frame}
	\begin{center}
		{\Huge Thanks!}
	\end{center}
\end{frame}

\end{document}